pipeline {
    environment {
      //hardcoded REGISTRY-USER -> unsafe - only for testing
      USER = "varelambzz"
      //hardcoded REGISTRY-PASSWORD -> unsafe - only for testing
      PASSWORD = ":eAhG7ANS9w7_y9"
      IMAGE = "traffic-light"
      BUILD_TAG = "v1.0.${BUILD_NUMBER}"
    }

    agent any
    tools {nodejs "node"}
    stages {
      stage('Cloning Repo') {
              steps {
                script {
                    git branch: 'main',
                    url: 'https://github.com/varelam-bzz/traffic-light.git'
             }
           }
      }

      stage('Building image') {
        steps{
          script {
          sh """
                set -e
                echo "Building Docker image..."
                docker build -t \$IMAGE:\$BUILD_TAG .
            """
          }
        }
      }

      stage('Push image in registry') {
        steps {
            script {
                sh """
                    echo "Logging in hub.docker.com registry"
                    echo "\$PASSWORD" | docker login -u "\$USER" --password-stdin
                    docker tag \$IMAGE:\$BUILD_TAG \$USER/\$IMAGE:latest

                    echo "Tagging latest..."
                    docker tag \$IMAGE:\$BUILD_TAG \$USER/\$IMAGE:latest
                    echo "Pushing images..."
                    docker push \$USER/\$IMAGE:latest
                """
            }
        }
      }

      stage('Remove Unused docker image') {
        steps{
          sh """
            set -e
            echo "Removing all images"
            docker rmi \$IMAGE:\$BUILD_TAG
            docker rmi \$USER/\$IMAGE:latest
            set +e
          """
        }
      }
    }
}
