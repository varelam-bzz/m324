pipeline {
    environment {
      // manage jenkins: global -> add credentials -> kind = "Secret text" -> ID = DOCKER_USER -> secret = username ("varelambzz")
      //get user with jenkins credential function
      USER = credentials('DOCKER_USER')
      //get password with jenkins credential function
      PASSWORD = credentials('DOCKER_PASSWORD')
      IMAGE = "traffic-api"
      BUILD_TAG = "v1.0.${BUILD_NUMBER}"
    }

    agent any
    tools {nodejs "node"}
    stages {
      stage('Cloning Repo') {
              steps {
                script {
                    git branch: 'main',
                    url: 'https://github.com/varelam-bzz/traffic-light.git'
             }
           }
      }

      stage('Building image') {
        steps{
          script {
          sh """
                set -e
                echo "Building Docker image..."
                docker build -t \$IMAGE:\$BUILD_TAG .
            """
          }
        }
      }

      stage('Push image in registry') {
        steps {
            script {
                sh """
                    echo "Logging in hub.docker.com registry"
                    echo "\$PASSWORD" | docker login -u "\$USER" --password-stdin
                    docker tag \$IMAGE:\$BUILD_TAG \$IMAGE:latest

                    echo "Tagging latest..."
                    docker tag \$IMAGE:\$BUILD_TAG \$IMAGE:latest
                    echo "Pushing images..."
                    docker push \$USER/\$IMAGE:latest
                """
            }
        }
      }

      stage('Remove Unused docker image') {
        steps{
          sh """
            set -e
            echo "Removing all images"
            docker rmi \$IMAGE:\$BUILD_TAG
            docker rmi \$USER/\$IMAGE:latest
            set +e
          """
        }
      }
    }
}
